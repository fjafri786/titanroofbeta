:root{
        --topbar-height: 24px;
        --propsbar-height: 74px;
        --navy:#0B2A3A;
        --navy2:#0E3348;

        --bg:#F5F7FB;
        --panel:#FFFFFF;
        --border:#E5EAF1;
        --text:#0F172A;
        --sub:#64748B;

        --c-ts:#DC2626;   /* red */
        --c-apt:#111827;  /* gray/black */
        --c-ds:#2563EB;   /* blue */
        --c-wind:#16A34A; /* green */
        --c-obs:#9333EA;  /* purple */

        --teal:#0BA7A5;

        --shadow: 0 14px 28px rgba(2,6,23,0.10);
        --shadowSoft: 0 10px 20px rgba(2,6,23,0.07);
        --ring: 0 0 0 3px rgba(11,167,165,0.18);

        --glass: rgba(255,255,255,0.72);
        --glass2: rgba(255,255,255,0.86);
        --glassBorder: rgba(226,232,240,0.70);
        --panelSoft: #F4F7FB;
        --panelEdge: rgba(148,163,184,0.25);
        --dashBg: rgba(219,234,254,0.8);
        --mobile-scale: 1;
      }

      *{ box-sizing:border-box; }
      html, body{
        margin:0;
        height:100%;
        min-height:100dvh;
        overflow:hidden;
        background:var(--bg);
        color:var(--text);
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
        /* iOS momentum scrolling inside panels */
        -webkit-text-size-adjust: 100%;
      }

      .topBar{
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: var(--topbar-height);
        background: #DC2626;
        z-index: 200;
        box-shadow: 0 2px 6px rgba(220,38,38,0.35);
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:11px;
        font-weight:1100;
        letter-spacing:0.8px;
        text-transform:uppercase;
        color:#fff;
      }

      .propertiesBar{
        position: fixed;
        top: var(--topbar-height);
        left: 0;
        width: 100%;
        height: var(--propsbar-height);
        z-index: 190;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 18px;
        background: linear-gradient(135deg, rgba(14,165,233,0.95), rgba(59,130,246,0.95));
        color: #fff;
        box-shadow: 0 12px 22px rgba(2,6,23,0.16);
        gap: 16px;
        pointer-events: auto;
      }
      .propertiesLeft{
        display:flex;
        align-items:center;
        gap:12px;
        min-width:0;
        flex:1;
        flex-wrap:nowrap;
      }
      .propertiesRight{
        display:flex;
        align-items:center;
        justify-content:flex-end;
        min-width:0;
        gap:10px 12px;
        flex-wrap:wrap;
      }
      .propertiesInfo{
        min-width:0;
      }
      .propertiesTitleRow{
        display:flex;
        align-items:center;
        gap:10px;
        min-width:0;
      }
      .propertiesTitle{
        font-size:18px;
        font-weight:1200;
        letter-spacing:0.2px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .propertiesSub{
        font-size:11px;
        font-weight:1000;
        opacity:0.92;
        line-height:1.3;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .propertiesPage{
        display:flex;
        align-items:center;
        gap:8px;
        margin-top:6px;
        flex-wrap:wrap;
      }
      .propertiesPageLabel{
        font-size:10px;
        font-weight:1200;
        letter-spacing:0.2px;
        color:#E0F2FE;
        text-transform:uppercase;
      }
      .propertiesPageSelect{
        position:relative;
        display:flex;
        align-items:center;
      }
      .propertiesPageInput{
        appearance:none;
        border-radius:999px;
        border:1px solid rgba(255,255,255,0.4);
        background: rgba(255,255,255,0.18);
        color:#fff;
        font-size:11px;
        font-weight:1100;
        padding:4px 26px 4px 10px;
      }
      .propertiesPageChevron{
        position:absolute;
        right:8px;
        width:12px;
        height:12px;
        pointer-events:none;
        color:#fff;
      }
      .propertiesActions{
        display:flex;
        align-items:center;
        gap:8px;
        flex-wrap:wrap;
        justify-content:flex-end;
      }

      .app{
        display:grid;
        grid-template-columns: 1fr minmax(320px, 420px);
        padding-top: calc(var(--topbar-height) + var(--propsbar-height));
        height: 100vh;
        height: 100dvh;
        min-height: 100vh;
        min-height: 100dvh;
        animation: viewEnter 0.35s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .app.sidebarCollapsed{
        grid-template-columns: 1fr 56px;
      }

      /* ========= CANVAS ZONE ========= */
      .canvasZone{
        position:relative;
        overflow:hidden;
        user-select:none;
        -webkit-user-select:none;
        background: #F8FAFC;
        height:100%;
      }
      .viewport{
        position:absolute;
        inset:0;
        overflow:hidden;
        /* IMPORTANT for iPad: allow our custom multi-touch */
        touch-action: none;
        cursor: default;
      }
      .resetViewBtn{
        position:absolute;
        right:16px;
        bottom:16px;
        display:flex;
        align-items:center;
        gap:6px;
        padding:8px 12px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,0.35);
        background: rgba(255,255,255,0.92);
        box-shadow: var(--shadowSoft);
        font-size:11px;
        font-weight:1100;
        color: var(--navy);
        cursor:pointer;
        z-index:70;
      }
      .resetViewBtn svg{
        width:14px;
        height:14px;
      }
      .stage{
        position:absolute;
        left:50%;
        top:50%;
        transform-origin: 0 0;
      }
      .sheet{
        width:1024px;
        height:720px;
        background:#fff;
        border-radius:18px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(15,23,42,0.06);
        overflow:hidden;
        position:relative;
      }
      .bgLayer{
        position:absolute;
        inset:0;
        width:100%;
        height:100%;
        transform-origin:center;
        pointer-events:none;
      }
      .bgImg{
        position:absolute;
        inset:0;
        width:100%;
        height:100%;
        object-fit:contain;
        pointer-events:none;
      }
      .bgMap,
      .bgPdf{
        position:absolute;
        inset:0;
        width:100%;
        height:100%;
        border:0;
        pointer-events:none;
      }
      .gridSvg{
        position:absolute;
        inset:0;
      }
      .gridSvg text{
        user-select:none;
        -webkit-user-select:none;
        pointer-events:none;
      }

      /* ========= TOOLBAR ========= */
      .toolbar{
        position: fixed;
        display:flex;
        align-items:center;
        justify-content:center;
        gap:10px;
        padding:8px 12px;
        border-radius: 999px;
        background: rgba(255,255,255,0.96);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(226,232,240,0.9);
        box-shadow: 0 12px 22px rgba(2,6,23,0.12);
        z-index: 80;
        user-select:none;
        -webkit-user-select:none;
        touch-action:none;
        cursor: grab;
      }
      .toolbar.vertical{
        flex-direction:column;
        align-items:stretch;
        gap:10px;
        padding:12px 8px;
        border-radius: 32px;
        --toolbar-control-size: 36px;
      }
      .toolbar.locked{
        cursor: default;
      }
      .toolbar.dragging{
        cursor: grabbing;
      }
      .tbCenter{
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:6px;
      }
      .tbTools{
        display:flex;
        align-items:center;
        gap:8px;
        flex-wrap:nowrap;
        padding:0;
        border-radius:0;
        background: transparent;
        border:none;
      }
      .tbMini{
        display:flex;
        align-items:center;
        gap:6px;
        padding-top:4px;
      }
      .toolbar.vertical .tbMini{
        flex-direction:column;
      }
      .tbMiniHint{
        font-size:10px;
        font-weight:1100;
        color: var(--sub);
        background: rgba(255,255,255,0.9);
        border:1px solid rgba(148,163,184,0.25);
        border-radius:999px;
        padding:4px 10px;
      }
      .obsPalette{
        position: fixed;
        display:flex;
        align-items:center;
        gap:6px;
        padding:8px;
        border-radius:14px;
        border:1px solid rgba(148,163,184,0.3);
        background: rgba(255,255,255,0.95);
        box-shadow: var(--shadowSoft);
        z-index: 120;
      }
      .miniToolBtn{
        width:28px;
        height:28px;
        border-radius:10px;
        border:1px solid rgba(148,163,184,0.4);
        background:#fff;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
      }
      .miniToolBtn svg{ width:16px; height:16px; }
      .miniToolBtn.active{
        border-color: rgba(147,51,234,0.5);
        color: var(--c-obs);
        box-shadow: 0 8px 14px rgba(2,6,23,0.12);
      }
      .toolbar.vertical .tbTools{
        flex-direction:column;
        align-items:stretch;
        gap:8px;
      }
      .tbDivider{
        width:1px;
        height:34px;
        background: rgba(148,163,184,0.4);
        border-radius: 999px;
      }
      .toolbar.vertical .tbDivider{
        width:100%;
        height:1px;
      }
      .tbZoom{
        display:flex;
        align-items:center;
        gap:8px;
        padding:0;
        border-radius:0;
        background: transparent;
        border:none;
      }
      .toolbar.vertical .tbZoom{
        flex-direction:column;
        align-items:stretch;
      }
      .tbZoomRow{
        display:flex;
        align-items:center;
        gap:8px;
      }
      .toolbar.vertical .tbZoomRow{
        flex-direction:column;
      }
      .tbPages{
        display:flex;
        align-items:center;
        gap:8px;
        padding:0;
        border-radius:0;
        background: transparent;
        border:none;
        flex-wrap:wrap;
      }
      .toolbar.vertical .tbPages{
        flex-direction:column;
        align-items:center;
      }
      .tbPageNav{
        display:flex;
        align-items:center;
        gap:8px;
        padding:0;
        border-radius:0;
        border:none;
        background: transparent;
        flex-wrap:wrap;
      }
      .tbPageTools{
        display:flex;
        align-items:center;
        gap:6px;
      }
      .toolbar.vertical .tbPageNav,
      .toolbar.vertical .tbPageTools{
        flex-direction:column;
      }
      .toolbar.vertical .tbPageNav{
        gap:10px;
      }
      .pageMeta{
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:6px;
        min-width:0;
      }
      .pageIndex{
        font-size:9px;
        font-weight:1100;
        color: var(--sub);
      }
      .pageName{
        border:2px solid rgba(107,114,128,0.65);
        background:#fff;
        padding:6px 12px;
        border-radius:18px;
        font-size:11px;
        font-weight:1200;
        color: var(--navy);
        cursor:pointer;
        max-width: 220px;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        display:flex;
        align-items:center;
        gap:6px;
      }
      .toolbar.vertical .pageName{
        flex-direction:column;
        text-align:center;
        padding:10px 8px;
        min-height:86px;
        white-space:normal;
        width:92px;
      }
      .toolbar.vertical .pageName span{
        white-space:normal;
        line-height:1.2;
      }
      .pageName svg{
        width:12px;
        height:12px;
        flex:0 0 auto;
      }
      .pageSelect{
        position:relative;
        display:flex;
        align-items:center;
      }
      .pageSelectInput{
        appearance:none;
        border-radius:999px;
        border:2px solid rgba(107,114,128,0.65);
        padding:6px 28px 6px 12px;
        font-size:12px;
        font-weight:1100;
        color: var(--navy);
        background:#fff;
        min-width:72px;
        text-align:center;
      }
      .pageSelectChevron{
        position:absolute;
        right:10px;
        width:14px;
        height:14px;
        pointer-events:none;
        color: var(--sub);
      }
      .pageNameInput{
        width:180px;
        border-radius:18px;
        border:2px solid rgba(107,114,128,0.65);
        padding:6px 12px;
        font-size:11px;
        font-weight:1100;
        color: var(--navy);
        text-align:center;
      }
      .toolbar.vertical .pageNameInput{
        width:92px;
        min-height:86px;
      }
      .toolbar.vertical .pageSelectInput,
      .toolbar.vertical .zReadout{
        width:92px;
      }
      .toolbar.vertical .iconBtn,
      .toolbar.vertical .tbGrab{
        width: var(--toolbar-control-size);
        height: var(--toolbar-control-size);
      }
      .iconBtn{
        width:32px;
        height:32px;
        border-radius:999px;
        border:2px solid rgba(148,163,184,0.55);
        background:#fff;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
      }
      .iconBtn:disabled{
        opacity:0.45;
        cursor:not-allowed;
      }
      .iconBtn svg{ width:18px; height:18px; }
      .iconBtn.active{
        background: rgba(15,23,42,0.08);
        border-color: rgba(15,23,42,0.28);
      }
      .iconBtn.zoom{
        border-color: rgba(147,197,253,0.9);
        color: rgba(30,64,175,0.9);
      }
      .iconBtn.nav{
        border-color: rgba(107,114,128,0.65);
        color: rgba(55,65,81,0.9);
      }

      .toolBtn{
        --toolColor: var(--c-ts);
        display:flex;
        align-items:center;
        justify-content:center;
        height:36px;
        width:36px;
        min-width:36px;
        padding:0;
        border-radius: 50%;
        border:2px solid var(--toolColor);
        background:#fff;
        cursor:pointer;
        font-family:inherit;
        appearance:none;
        transition: transform 0.10s ease, box-shadow 0.10s ease, border-color 0.10s ease, background 0.10s ease;
        white-space:nowrap;
        color: var(--toolColor);
        touch-action: manipulation;
      }
      .toolBtn .toolText{
        font-size:11px;
        font-weight:1200;
        letter-spacing:0.4px;
      }
      .toolBtn:hover{
        transform: translateY(-1px);
        box-shadow: 0 8px 14px rgba(2,6,23,0.10);
      }
      .toolBtn.active{
        background: var(--toolColor);
        border-color: var(--toolColor);
        color:#fff;
        box-shadow: 0 10px 16px rgba(2,6,23,0.12);
      }
      .toolBtn.ts{ --toolColor: var(--c-ts); }
      .toolBtn.apt{ --toolColor: var(--c-apt); }
      .toolBtn.ds{ --toolColor: var(--c-ds); }
      .toolBtn.wind{ --toolColor: var(--c-wind); }
      .toolBtn.obs{ --toolColor: var(--c-obs); }

      .lockIcon{
        width:30px;
        height:30px;
        display:flex;
        align-items:center;
        justify-content:center;
        border-radius: 10px;
        border:1px solid rgba(226,232,240,0.95);
        background:#fff;
        cursor:pointer;
        user-select:none;
        -webkit-user-select:none;
      }
      .lockIcon:hover{ background: rgba(241,245,249,0.85); }
      .lockIcon svg{ width:18px; height:18px; }
      .lockIcon.locked svg{ color:#F59E0B; }
      .lockIcon.unlocked svg{ color: rgba(148,163,184,1); }
      .lockToggle{
        flex:0 0 auto;
      }
      .lockStatus{
        font-size:12px;
        font-weight:1100;
        color: var(--navy);
      }
      .tbGrab{
        width:32px;
        height:32px;
        border-radius: 999px;
        border:2px solid rgba(226,232,240,0.95);
        background:#fff;
        display:flex;
        align-items:center;
        justify-content:center;
        color: rgba(100,116,139,0.9);
        cursor: grab;
      }
      .tbGrab svg{ width:14px; height:14px; }

      .toolbar.mobile{
        flex-direction: column;
        align-items:center;
        gap:6px;
        padding:6px 8px;
        border-radius:22px;
        cursor: default;
      }
      .toolbar.mobile .tbDivider{
        display:none;
      }
      .tbMobile{
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:6px;
      }
      .tbMobileTabs{
        display:flex;
        align-items:center;
        justify-content:center;
        gap:8px;
      }
      .tbMobileTabs .iconBtn{
        width:28px;
        height:28px;
        border-radius:12px;
      }
      .tbMobileTabs .iconBtn svg{
        width:18px;
        height:18px;
      }
      .tbMobileBody{
        display:flex;
        align-items:center;
        justify-content:center;
        gap:8px;
      }
      .toolbar.mobile .tbTools{
        justify-content:center;
        flex-wrap:wrap;
        gap:6px;
      }
      .toolbar.mobile .toolBtn{
        width:30px;
        min-width:30px;
        height:30px;
        padding:0;
      }
      .toolbar.mobile .toolBtn.expanded{
        width:30px;
        padding:0;
      }
      .toolbar.mobile .toolText{
        display:none;
      }
      .toolbar.mobile .tbZoomRow{
        display:flex;
        align-items:center;
        gap:8px;
      }
      .toolbar .zReadout{
        font-size:12px;
        font-weight:1200;
        color: var(--navy);
        padding:6px 12px;
        border-radius:999px;
        border:2px solid rgba(147,197,253,0.9);
        background: #fff;
        min-width:64px;
        text-align:center;
      }
      .toolbar.mobile .tbPages{
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:6px;
      }
      .toolbar.mobile .pageSelectInput{
        min-width:64px;
        padding:6px 26px 6px 10px;
      }
      .toolbar.mobile .pageName{
        max-width:160px;
      }
      .toolbar.mobile .tbPageNav.compact{
        display:flex;
        align-items:center;
        gap:8px;
      }
      .pageIndex.compact{
        font-size:11px;
        font-weight:1100;
        color: var(--navy);
      }

      /* ========= NAV TOOLS (BOTTOM RIGHT) ========= */
      .navTools{
        position:absolute;
        right:16px;
        bottom:16px;
        display:flex;
        flex-direction:column;
        gap:10px;
        z-index: 70;
        user-select:none;
        -webkit-user-select:none;
      }
      .navCard{
        background: rgba(255,255,255,0.92);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(226,232,240,0.85);
        border-radius: 14px;
        box-shadow: var(--shadowSoft);
        padding: 8px 10px;
        width: 220px;
      }
      .navRow{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:8px;
      }
      .zBtns{ display:flex; gap:6px; flex-wrap:nowrap; }
      .zBtn{
        padding:4px 6px;
        border-radius:9px;
        border:1px solid rgba(226,232,240,0.95);
        background:#fff;
        cursor:pointer;
        font-size:10px;
        font-weight:1100;
        user-select:none;
        touch-action: manipulation;
      }
      .zBtn:hover{ background:#F8FAFC; }
      .zReadout{
        font-size:10px;
        font-weight:1100;
        color: var(--navy);
        padding: 4px 6px;
        border-radius:9px;
        border:1px solid rgba(226,232,240,0.95);
        background: #fff;
        min-width: 48px;
        text-align:center;
      }

      /* ========= PROPERTIES PANEL ========= */
      .panel{
        background: linear-gradient(180deg, rgba(244,247,251,0.98), rgba(255,255,255,0.96));
        border-left: 1px solid var(--panelEdge);
        display:flex;
        flex-direction:column;
        box-shadow: -10px 0 26px rgba(2,6,23,0.05);
        position:relative;
        min-width: 0;
        min-height: 0;
        height: 100%;
        backdrop-filter: blur(10px);
        transform: translateX(0);
        transition: width 0.25s ease, box-shadow 0.25s ease, transform 0.25s ease;
      }
      .panel.collapsed{
        width:56px;
        min-width:56px;
        border-left:1px solid var(--panelEdge);
        opacity:1;
        pointer-events:auto;
        overflow:hidden;
        align-items:center;
        transform: translateX(10px);
      }
      .panel.collapsed .panelHeader{
        justify-content:center;
        padding:10px 0;
      }
      .panelHeader{
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:10px 12px 6px;
        gap:8px;
        border-bottom: 1px solid rgba(226,232,240,0.8);
      }
      .panelHeaderTitle{
        font-size:12px;
        font-weight:1200;
        color: var(--navy);
        letter-spacing:0.4px;
        text-transform:uppercase;
      }
      .panel.collapsed .panelHeaderTitle{
        display:none;
      }

      /* Header with 3 lines + single edit icon */
      .pHeader{
        padding:12px 16px 14px;
        background: linear-gradient(135deg, rgba(14,165,233,0.92), rgba(37,99,235,0.92));
        color:#fff;
        display:flex;
        flex-direction:column;
        align-items:stretch;
        gap:12px;
        min-width:0;
      }
      .hdrModeRow{
        display:flex;
        align-items:center;
        justify-content:flex-end;
      }
      .hdrTop{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap:12px;
      }
      .hdrText{
        min-width:0;
        flex:1;
      }
      .hdrLine1{
        font-size:22px;
        font-weight:1200;
        letter-spacing:0.2px;
        line-height:1.15;
        white-space:normal;
        overflow-wrap:break-word;
        word-break:normal;
      }
      .hdrLine2{
        margin-top:6px;
        font-size:12px;
        font-weight:1000;
        opacity:0.92;
        line-height:1.35;
        white-space:normal;
        overflow-wrap:break-word;
        word-break:normal;
      }
      .hdrLine3{
        margin-top:6px;
        font-size:12px;
        font-weight:1000;
        opacity:0.92;
        line-height:1.35;
        white-space:normal;
        overflow-wrap:break-word;
        word-break:normal;
      }

      .hdrEditIcon{
        width:34px;
        height:34px;
        border-radius:14px;
        border:1px solid rgba(255,255,255,0.22);
        background: rgba(255,255,255,0.12);
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        flex: 0 0 auto;
        color:#fff;
        appearance:none;
        padding:0;
      }
      .hdrEditIcon:hover{ background: rgba(255,255,255,0.18); }
      .hdrEditIcon.edit{
        background: rgba(11,167,165,0.22);
        border-color: rgba(255,255,255,0.45);
      }
      .hdrEditIcon.collapse{
        background: rgba(15,23,42,0.35);
        border-color: rgba(255,255,255,0.18);
      }
      .hdrEditIcon.collapse:hover{ background: rgba(15,23,42,0.28); }
      .hdrIconGroup{
        display:flex;
        align-items:center;
        gap:8px;
      }
      .hdrActions{
        display:flex;
        align-items:center;
        gap:8px;
        flex-wrap:wrap;
        justify-content:flex-start;
        row-gap:8px;
      }
      .hdrPill{
        display:inline-flex;
        align-items:center;
        border-radius:999px;
        border:1px solid rgba(255,255,255,0.32);
        background: rgba(255,255,255,0.16);
        overflow:hidden;
      }
      .hdrPillBtn{
        border:none;
        background:transparent;
        color:#fff;
        font-size:11px;
        font-weight:1200;
        padding:6px 10px;
        cursor:pointer;
        display:inline-flex;
        align-items:center;
        gap:6px;
        touch-action: manipulation;
      }
      .hdrPillBtn + .hdrPillBtn{
        border-left:1px solid rgba(255,255,255,0.22);
      }
      .hdrBtn{
        padding:6px 9px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,0.32);
        background: rgba(255,255,255,0.16);
        color:#fff;
        font-size:11px;
        font-weight:1200;
        cursor:pointer;
        white-space:nowrap;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap:6px;
        touch-action: manipulation;
      }
      .hdrBtn.mobileMenuBtn{
        padding:6px 12px;
        border-radius:999px;
        background: rgba(15,23,42,0.35);
        border-color: rgba(255,255,255,0.4);
      }
      .hdrBtn.mobileMenuBtn.active{
        background: rgba(15,23,42,0.55);
        box-shadow: 0 6px 14px rgba(2,6,23,0.25);
      }
      .hdrBtn.iconOnly{
        padding:6px 8px;
      }
      .hdrBtn.editInline{
        padding:6px 10px;
        border-radius:999px;
        font-size:14px;
      }
      .hdrBtn .icon{
        width:16px;
        height:16px;
      }
      .hdrBtn.collapseArrow{
        font-size:18px;
        line-height:1;
        width:36px;
        height:36px;
        padding:0;
        border-radius:12px;
      }
      .saveNotice{
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding:6px 10px;
        border-radius:999px;
        background: rgba(15,23,42,0.22);
        border:1px solid rgba(255,255,255,0.28);
        font-size:11px;
        font-weight:1100;
        color:#fff;
        max-width:100%;
        align-self:flex-start;
      }
      .saveToast{
        position: fixed;
        top: calc(var(--topbar-height) + var(--propsbar-height) + 8px);
        left: 50%;
        transform: translateX(-50%);
        z-index: 180;
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding:6px 12px;
        border-radius:999px;
        background: rgba(15,23,42,0.85);
        color:#fff;
        font-size:11px;
        font-weight:1100;
        box-shadow: 0 12px 22px rgba(2,6,23,0.2);
      }
      .viewTabsDock{
        display:flex;
        justify-content:flex-end;
        padding:8px 16px 12px;
        background: var(--panelSoft);
        border-top:1px solid var(--border);
      }
      .viewTabs{
        display:flex;
        align-items:center;
        gap:6px;
        padding:4px;
        border-radius:999px;
        background:#F8FAFC;
        border:1px solid rgba(226,232,240,0.9);
      }
      .viewTabs button{
        border:none;
        background:transparent;
        color: var(--sub);
        font-size:12px;
        font-weight:1200;
        padding:6px 14px;
        cursor:pointer;
        border-radius:999px;
        transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      }
      .viewTabs button.active{
        background: linear-gradient(135deg, rgba(14,165,233,0.95), rgba(59,130,246,0.95));
        color:#fff;
        box-shadow: 0 10px 16px rgba(2,6,23,0.12);
      }
      .modeToggle{
        display:flex;
        align-items:center;
        gap:6px;
        padding:4px;
        border-radius:999px;
        background: rgba(255,255,255,0.9);
        border:1px solid rgba(226,232,240,0.9);
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);
      }
      .modeToggle button{
        border:none;
        background:transparent;
        color: var(--sub);
        font-size:11px;
        font-weight:1200;
        padding:6px 10px;
        cursor:pointer;
        border-radius:999px;
      }
      .modeToggle button.active{
        background: linear-gradient(135deg, rgba(14,165,233,0.95), rgba(59,130,246,0.95));
        color:#fff;
        box-shadow: 0 10px 16px rgba(2,6,23,0.12);
      }
      .panelRail{
        width:100%;
        display:flex;
        justify-content:flex-end;
        padding:8px 10px 0;
      }
      .panelToggleBtn{
        display:flex;
        align-items:center;
        justify-content:center;
        width:32px;
        height:32px;
        border-radius:10px;
        background: rgba(15,23,42,0.08);
        border:1px solid rgba(148,163,184,0.35);
        cursor:pointer;
        color: var(--navy);
        touch-action: manipulation;
      }
      .panelToggleBtn:hover{ background: rgba(15,23,42,0.18); }
      .panelBody{
        display:flex;
        flex-direction:column;
        min-height:0;
        flex:1;
        overflow:hidden;
        height:100%;
      }
      .panel.collapsed .panelBody{
        display:none;
      }

      .hdrEditPanel{
        padding: 12px 16px;
        border-bottom: 1px solid rgba(226,232,240,0.95);
        background: linear-gradient(180deg, rgba(244,247,251,0.98), rgba(236,240,246,0.98));
      }
      .modalBackdrop{
        position: fixed;
        inset: 0;
        background: rgba(15,23,42,0.45);
        backdrop-filter: blur(3px);
        z-index: 220;
        display:flex;
        align-items:center;
        justify-content:center;
        padding: 16px;
      }
      .modalCard{
        width: min(860px, 96vw);
        max-height: 92dvh;
        background: #fff;
        border-radius: 18px;
        border: 1px solid rgba(226,232,240,0.95);
        box-shadow: 0 20px 40px rgba(2,6,23,0.2);
        overflow: hidden;
        display:flex;
        flex-direction:column;
      }
      .modalHeader{
        padding: 14px 18px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        border-bottom: 1px solid rgba(226,232,240,0.95);
        background: linear-gradient(135deg, rgba(14,165,233,0.12), rgba(37,99,235,0.12));
      }
      .modalTitle{
        font-size:14px;
        font-weight:1200;
        color: var(--navy);
      }
      .modalBody{
        padding: 16px 18px 6px;
        overflow:auto;
        min-height:0;
        flex:1;
      }
      .modalActions{
        padding: 12px 18px 16px;
        display:flex;
        gap:10px;
        justify-content:flex-end;
      }

      .pScroll{
        flex:1;
        overflow-y:auto;
        overflow-x:hidden;
        scrollbar-gutter: stable both-edges;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch; /* iOS */
        padding:10px;
        display:flex;
        flex-direction:column;
        gap:12px;
        min-width:0;
        min-height:0;
        max-height:100%;
        height:100%;
      }

      .propsSticky{
        position: sticky;
        top: 0;
        z-index: 5;
        background: #fff;
        padding-bottom:10px;
        margin-bottom:10px;
      }

      .card{
        background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(248,250,252,0.95));
        border:1px solid rgba(226,232,240,0.9);
        border-radius:16px;
        padding:12px;
        box-shadow: var(--shadowSoft);
        min-width:0;
      }
      .itemsPanel{
        background: #fff;
        border-radius:18px;
        box-shadow: 0 14px 26px rgba(2,6,23,0.06);
      }

      .lbl{
        display:block;
        font-size:11px;
        font-weight:1000;
        text-transform:uppercase;
        color: var(--sub);
        letter-spacing:0.45px;
        margin-bottom:8px;
      }
      .inp, select, textarea{
        width:100%;
        padding:10px 12px; /* touch friendly */
        font-size:13px;
        border:1px solid var(--border);
        border-radius:14px;
        background:#fff;
        outline:none;
        color:var(--text);
      }
      textarea{ min-height:76px; resize:vertical; }
      .inp:focus, select:focus, textarea:focus{
        border-color: var(--teal);
        box-shadow: var(--ring);
      }

      .row{ display:flex; gap:10px; align-items:center; min-width:0; }
      .rowTop{ display:flex; gap:10px; align-items:flex-start; min-width:0; }
      .row > *{ flex:1; min-width:0; }
      .mapZoomControls{
        display:flex;
        align-items:center;
        gap:6px;
      }
      .mapZoomControls .iconBtn{
        width:28px;
        height:28px;
      }
      .mapZoomInput{
        text-align:center;
        padding:6px 8px;
      }

      /* uniform direction buttons */
      .radioGrid{
        display:flex;
        gap:10px;
        flex-wrap:nowrap; /* keep same size */
      }
      .radioGrid.wrap{
        flex-wrap:wrap;
      }
      .radio{
        flex: 1 1 0px;
        min-width: 0;
        text-align:center;
        padding:12px 8px; /* touch */
        border-radius: 14px;
        border:1px solid var(--border);
        background:#fff;
        cursor:pointer;
        font-size:13px;
        font-weight:1100;
        user-select:none;
        white-space:nowrap;
        touch-action: manipulation;
      }
      .radio.active{
        background: linear-gradient(135deg, var(--navy2), var(--navy));
        border-color: rgba(14,51,72,0.55);
        color:#fff;
        box-shadow: 0 10px 16px rgba(2,6,23,0.12);
      }

      .btn{
        padding:10px 12px; /* touch */
        border-radius:14px;
        border:1px solid var(--border);
        background:#fff;
        cursor:pointer;
        font-size:12px;
        font-weight:1100;
        user-select:none;
        transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap:8px;
        touch-action: manipulation;
      }
      .btn.iconLabel svg{
        width:16px;
        height:16px;
      }
      .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 16px rgba(2,6,23,0.08); background:#F8FAFC; }
      .btnPrimary{
        border-color: rgba(11,167,165,0.35);
        color: var(--teal);
        background: rgba(11,167,165,0.06);
      }
      .btnDanger{
        border-color: rgba(220,38,38,0.35);
        color: #B91C1C;
        background: rgba(220,38,38,0.06);
      }
      .btnFull{ width:100%; }

      .fileMeta{
        font-size:12px;
        color: var(--sub);
        margin-top:6px;
        word-break:break-word;
      }
      .fileMeta.indent{
        margin-left:44px;
      }
      .photoPreview{
        margin-top:8px;
        border-radius:12px;
        border:1px solid rgba(226,232,240,0.95);
        background:#fff;
        padding:6px;
        width:120px;
        box-shadow: var(--shadowSoft);
      }
      .photoPreview.indent{
        margin-left:44px;
      }
      .photoPreview img{
        width:100%;
        height:auto;
        display:block;
        border-radius:8px;
        object-fit:cover;
      }

      /* Items list */
      .groupHeader{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:8px;
        font-size:12px;
        font-weight:1100;
        text-transform:none;
        color: var(--navy);
        letter-spacing:0.2px;
        margin: 8px 0 10px 0;
        padding:10px 12px;
        border-radius:14px;
        border:1px solid rgba(148,163,184,0.35);
        background:#F8FAFC;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6);
        cursor:pointer;
      }
      .groupHeader .groupTitle{
        display:flex;
        align-items:center;
        gap:8px;
      }
      .groupHeader .groupCount{
        font-size:11px;
        font-weight:1200;
        padding:4px 8px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,0.45);
        background:#fff;
        color:#0B1220;
        text-transform:none;
      }
      .groupHeader .groupChevron{
        width:26px;
        height:26px;
        display:flex;
        align-items:center;
        justify-content:center;
        border-radius:999px;
        background:#fff;
        border:1px solid rgba(148,163,184,0.45);
        box-shadow: 0 4px 8px rgba(2,6,23,0.08);
      }
      .groupHeader.ts{
        border-left:5px solid rgba(220,38,38,0.9);
        background: linear-gradient(90deg, rgba(254,226,226,0.7), rgba(255,255,255,0.9));
      }
      .groupHeader.apt{
        border-left:5px solid rgba(17,24,39,0.8);
        background: linear-gradient(90deg, rgba(226,232,240,0.7), rgba(255,255,255,0.9));
      }
      .groupHeader.ds{
        border-left:5px solid rgba(37,99,235,0.8);
        background: linear-gradient(90deg, rgba(219,234,254,0.7), rgba(255,255,255,0.9));
      }
      .groupHeader.wind{
        border-left:5px solid rgba(22,163,74,0.8);
        background: linear-gradient(90deg, rgba(220,252,231,0.7), rgba(255,255,255,0.9));
      }
      .groupHeader.obs{
        border-left:5px solid rgba(147,51,234,0.8);
        background: linear-gradient(90deg, rgba(237,233,254,0.7), rgba(255,255,255,0.9));
      }
      .itemRow{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap:10px;
        padding: 12px 12px;
        border-radius: 16px;
        border:1px solid var(--border);
        background:#fff;
        cursor:pointer;
        user-select:none;
        border-left-width:5px;
        transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease, border-color 0.08s ease;
      }
      .itemRow:hover{ transform: translateY(-1px); box-shadow: 0 10px 16px rgba(2,6,23,0.08); background:#F8FAFC; }
      .itemRow.selected{
        border-color: rgba(11,167,165,0.55);
        box-shadow: var(--ring);
        background:#F1F5F9;
      }
      .itemInfo{
        min-width:0;
        flex:1;
      }
      .itemInfo b{
        display:flex;
        align-items:center;
        gap:8px;
        font-size:13px;
        font-weight:1200;
        white-space:normal;
        overflow-wrap:anywhere;
        line-height:1.25;
        color:#0B1220;
      }
      .itemInfo span{
        display:block;
        font-size:12px;
        color: var(--sub);
        margin-top:4px;
        white-space:normal;
        overflow-wrap:anywhere;
        line-height:1.25;
      }

      .badgeDMG{
        font-size:11px;
        font-weight:1200;
        padding:4px 8px;
        border-radius:999px;
        border:1px solid rgba(220,38,38,0.35);
        background: rgba(220,38,38,0.08);
        color:#B91C1C;
        white-space:nowrap;
        flex:0 0 auto;
      }

      /* Marker overlays */
      .marker{
        position:absolute;
        transform: translate(-50%,-50%);
        width: 20px;
        height: 20px;
        display:flex;
        align-items:center;
        justify-content:center;
        color:#fff;
        font-weight:1200;
        font-size:9px;
        border:1.5px solid rgba(255,255,255,0.92);
        box-shadow: 0 10px 18px rgba(2,6,23,0.22);
        user-select:none;
      }
      .handle{ fill:#fff; stroke: var(--c-ts); stroke-width:2; }
      .handleDot{ fill: var(--c-ts); }
      .handleObs{ fill:#fff; stroke: var(--c-obs); stroke-width:2; }
      .handleObsDot{ fill: var(--c-obs); }

      .muted{ color: var(--sub); font-size:12px; font-style:italic; }
      .tiny{ color: var(--sub); font-size:12px; line-height:1.35; }
      .hr{ height:1px; background: rgba(226,232,240,0.95); margin: 10px 0; }

      /* ========= DASHBOARD ========= */
      .dashLauncher{
        position:absolute;
        left:16px;
        bottom:16px;
        z-index:70;
      }
      .dashLauncherBtn{
        width:42px;
        height:42px;
        border-radius:14px;
        border:1px solid rgba(148,163,184,0.35);
        background: rgba(255,255,255,0.92);
        box-shadow: var(--shadowSoft);
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
      }
      .dashLauncherBtn svg{ width:18px; height:18px; }
      .dashPopover{
        position:fixed;
        width:min(540px, 92vw);
        background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(30,64,175,0.92));
        border:1px solid rgba(148,163,184,0.25);
        border-radius:18px;
        box-shadow: var(--shadow);
        padding:14px;
        display:flex;
        flex-direction:column;
        gap:12px;
        z-index:80;
        color: #F8FAFC;
        opacity:0;
        transform: translate(-8px, 8px) scale(0.95);
        transform-origin: left bottom;
        transition: opacity 0.18s ease, transform 0.18s ease;
      }
      .dashPopover.open{
        opacity:1;
        transform: translate(0, 0) scale(1);
      }
      .dashPopover.closing{
        opacity:0;
        transform: translate(-6px, 6px) scale(0.94);
      }
      .dashPopover.dragging{
        cursor: grabbing;
      }
      .dashHeader{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap:12px;
        cursor: grab;
      }
      .dashTitleText{
        font-size:14px;
        font-weight:1300;
        color: #F8FAFC;
      }
      .dashSubtitle{
        font-size:11px;
        font-weight:1100;
        color: rgba(248,250,252,0.72);
        margin-top:4px;
      }
      .dashCompact{
        display:flex;
        flex-direction:column;
        gap:12px;
      }
      .dashCompactSection{
        display:flex;
        flex-direction:column;
        gap:8px;
        padding:10px;
        border-radius:14px;
        border:1px solid rgba(255,255,255,0.12);
      }
      .dashCompactSection.summary{
        background: rgba(248,113,113,0.12);
      }
      .dashCompactSection.indicators{
        background: rgba(96,165,250,0.12);
      }
      .dashSectionToggle{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        background: transparent;
        border:0;
        padding:0;
        cursor:pointer;
        color: inherit;
      }
      .dashSectionToggle svg{
        width:14px;
        height:14px;
      }
      .dashCompactTitle{
        font-size:11px;
        font-weight:1200;
        text-transform:uppercase;
        color: rgba(148,163,184,0.8);
        letter-spacing:0.4px;
      }
      .dashSummaryGrid{
        display:grid;
        gap:10px;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }
      .dashIndicatorsGrid{
        display:grid;
        gap:10px;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }
      .dashSummaryCard,
      .dashIndicatorCard{
        border-radius:14px;
        border:1px solid rgba(148,163,184,0.2);
        background: rgba(15,42,63,0.75);
        padding:10px;
        display:flex;
        flex-direction:column;
        gap:6px;
      }
      .dashDir{
        font-size:12px;
        font-weight:1300;
        color: #F8FAFC;
      }
      .dashStatRow{
        display:flex;
        align-items:center;
        justify-content:space-between;
        font-size:11px;
        font-weight:1100;
        color: rgba(226,232,240,0.85);
      }
      .dashMuted{ opacity:0.75; font-weight:1100; }
      .dashAlert{ color:#B91C1C; }
      .dashOk{ color:#6EE7B7; }
      .dashWind{ color:#34D399; }
      .dashBlue{ color:#60A5FA; }
      .dashDark{ color:#E2E8F0; }

      /* ========= REPORT VIEW ========= */
      .reportView{
        display:flex;
        flex-direction:column;
        padding-top: calc(var(--topbar-height) + var(--propsbar-height));
        height: 100vh;
        height: 100dvh;
        background: linear-gradient(180deg, rgba(14,165,233,0.12), rgba(139,92,246,0.14) 55%, rgba(245,247,251,1) 100%);
        animation: viewEnter 0.35s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .reportView .pHeader{
        background: linear-gradient(135deg, rgba(14,165,233,0.92), rgba(59,130,246,0.9), rgba(168,85,247,0.85));
      }
      .reportTabs{
        display:flex;
        flex-wrap:wrap;
        gap:8px;
        padding:8px 16px;
        background: var(--panelSoft);
        border-bottom: 1px solid var(--border);
      }
      .reportTabBtn{
        border:1px solid rgba(148,163,184,0.35);
        background:#fff;
        color: var(--navy);
        padding:6px 12px;
        border-radius:999px;
        font-size:11px;
        font-weight:1200;
        cursor:pointer;
      }
      .reportTabBtn.active{
        background: var(--navy2);
        border-color: rgba(14,51,72,0.55);
        color:#fff;
        box-shadow: 0 10px 16px rgba(2,6,23,0.12);
      }
      .statusDot{
        display:inline-block;
        width:8px;
        height:8px;
        border-radius:999px;
        background: rgba(148,163,184,0.7);
        margin-left:6px;
      }
      .statusDot.ready{ background: #16A34A; }
      .reportContent{
        flex:1;
        overflow:auto;
        padding:14px;
        display:flex;
        flex-direction:column;
        gap:14px;
      }
      .reportCard{
        background:#fff;
        border:1px solid var(--border);
        border-radius:16px;
        padding:12px;
        box-shadow: var(--shadowSoft);
      }
      .reportSectionTitle{
        font-size:11px;
        font-weight:1200;
        text-transform:uppercase;
        color: #1F2937;
        letter-spacing:0.45px;
        margin-bottom:12px;
        padding:6px 10px;
        border-radius:10px;
        background: linear-gradient(135deg, rgba(14,165,233,0.22), rgba(99,102,241,0.18));
        border:1px solid rgba(59,130,246,0.25);
      }
      .reportGrid{
        display:grid;
        gap:12px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      /* ========= PHOTOS VIEW ========= */
      .photosView{
        display:flex;
        flex-direction:column;
        padding-top: calc(var(--topbar-height) + var(--propsbar-height));
        height: 100vh;
        height: 100dvh;
        background: linear-gradient(180deg, rgba(14,165,233,0.08), rgba(59,130,246,0.08) 55%, rgba(245,247,251,1) 100%);
        animation: viewEnter 0.35s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .photosContent{
        flex:1;
        overflow:auto;
        padding:16px;
        display:flex;
        flex-direction:column;
        gap:18px;
      }
      .photosHeader{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:16px;
      }
      .photosTitle{
        font-size:18px;
        font-weight:1200;
        color: var(--navy);
      }
      .photosSub{
        font-size:12px;
        font-weight:1100;
        color: var(--sub);
      }
      .photoSection{
        background:#fff;
        border:1px solid var(--border);
        border-radius:16px;
        padding:12px;
        box-shadow: var(--shadowSoft);
        display:flex;
        flex-direction:column;
        gap:12px;
      }
      .photoSectionHeader{
        display:flex;
        align-items:center;
        justify-content:flex-start;
        gap:12px;
        flex-wrap:wrap;
      }
      .photoGroupSection{
        border:1px solid rgba(226,232,240,0.9);
        border-radius:14px;
        background:#F8FAFC;
        padding:8px;
        display:flex;
        flex-direction:column;
        gap:8px;
      }
      .photoGroupHeader{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        padding:8px 10px;
        border-radius:12px;
        border:1px solid rgba(148,163,184,0.25);
        background:#fff;
        cursor:pointer;
        text-align:left;
      }
      .photoGroupBody{
        display:flex;
        flex-direction:column;
        gap:10px;
        padding:4px 6px 6px;
      }
      .photoSectionTitle{
        font-size:11px;
        font-weight:1200;
        text-transform:uppercase;
        letter-spacing:0.5px;
        color: #1F2937;
      }
      .photoSectionMeta{
        font-size:11px;
        font-weight:1100;
        color: var(--sub);
        margin-left:auto;
        text-align:right;
        min-width:72px;
      }
      .photoGroup{
        display:flex;
        flex-direction:column;
        gap:8px;
      }
      .photoGroupTitle{
        font-size:12px;
        font-weight:1200;
        color: var(--navy2);
      }
      .photoGrid{
        display:grid;
        gap:12px;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
      .photoCard{
        border:1px solid rgba(226,232,240,0.95);
        border-radius:14px;
        overflow:hidden;
        background:#F8FAFC;
        display:flex;
        flex-direction:column;
      }
      .photoThumb{
        background:#E2E8F0;
        display:flex;
        align-items:center;
        justify-content:center;
        height:150px;
        aspect-ratio: 4 / 3;
        overflow:hidden;
      }
      .photoThumb img{
        width:100%;
        height:100%;
        object-fit:cover;
      }
      .photoMeta{
        padding:10px;
        display:flex;
        flex-direction:column;
        gap:6px;
      }
      .photoCaption{
        font-size:12px;
        font-weight:1200;
        color:#0F172A;
      }
      .photoNote{
        font-size:11px;
        font-weight:1100;
        color: var(--sub);
      }
      .photoEmpty{
        font-size:12px;
        font-weight:1100;
        color: var(--sub);
        padding:6px 0;
      }
      .exteriorGrid{
        display:flex;
        flex-direction:column;
        gap:12px;
      }
      .exteriorCard{
        display:grid;
        grid-template-columns: minmax(200px, 240px) 1fr;
        gap:12px;
        padding:10px;
        border-radius:14px;
        border:1px solid rgba(226,232,240,0.95);
        background:#F8FAFC;
      }
      .exteriorPreview{
        display:flex;
        flex-direction:column;
        gap:8px;
      }
      .exteriorPreview img{
        width:100%;
        height:160px;
        border-radius:12px;
        object-fit:cover;
        background:#E2E8F0;
      }
      .photoPlaceholder{
        display:flex;
        align-items:center;
        justify-content:center;
        height:160px;
        border-radius:12px;
        background:#E2E8F0;
        color: var(--sub);
        font-size:12px;
        font-weight:1100;
      }
      .exteriorFields{
        display:flex;
        flex-direction:column;
        gap:10px;
      }
      .exteriorActions{
        display:flex;
        justify-content:flex-end;
      }
      .inlineTag{
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid rgba(226,232,240,0.95);
        background:#F8FAFC;
        font-size:12px;
        font-weight:1100;
        color: var(--navy);
      }
      .chipList{
        display:flex;
        flex-wrap:wrap;
        gap:8px;
      }
      .chip{
        display:flex;
        align-items:center;
        gap:6px;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,0.35);
        background:#fff;
        font-size:12px;
        font-weight:1100;
        cursor:pointer;
        user-select:none;
      }
      .chip.active{
        border-color: rgba(14,165,233,0.4);
        background: rgba(14,165,233,0.12);
        color:#0B2A3A;
      }
      .sectionHint{
        font-size:12px;
        color: var(--sub);
        margin-top:8px;
      }
      .personRow{
        display:grid;
        gap:10px;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        align-items:center;
      }
      .personActions{
        display:flex;
        justify-content:flex-end;
      }

      /* ========= EXPORT / PRINT ========= */
      .printSheet{
        display:none;
        color:#0F172A;
        font-size:12px;
      }
      .printHeader{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        margin-bottom:16px;
      }
      .printTitle{
        font-size:20px;
        font-weight:1300;
      }
      .printSection{
        margin-bottom:16px;
        page-break-inside: avoid;
        border:1px solid rgba(226,232,240,0.9);
        border-radius:14px;
        padding:14px;
        background:#fff;
      }
      .printPage{
        page-break-after: always;
        padding: 8px 0;
      }
      .printPage:last-child{
        page-break-after: auto;
      }
      .printDiagramWrap{
        display:flex;
        flex-direction:column;
        gap:12px;
      }
      .printDiagramSheet{
        position:relative;
        width:100%;
        aspect-ratio: 1024 / 720;
        border-radius:12px;
        border:1px solid rgba(226,232,240,0.95);
        overflow:hidden;
        background:#fff;
      }
      .printSection h3{
        margin:0 0 8px 0;
        font-size:13px;
        font-weight:1200;
        text-transform:uppercase;
        letter-spacing:0.4px;
        color:#0F172A;
      }
      .printGrid{
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap:12px;
      }
      .printCard{
        border:1px solid rgba(226,232,240,0.95);
        border-radius:12px;
        padding:10px;
        background:#F8FAFC;
        break-inside: avoid;
      }
      .printPhoto{
        width:100%;
        aspect-ratio: 4 / 3;
        border-radius:10px;
        border:1px solid rgba(226,232,240,0.95);
        overflow:hidden;
        display:flex;
        align-items:center;
        justify-content:center;
        background:#fff;
        break-inside: avoid;
      }
      .printPhoto img{
        width:100%;
        height:100%;
        object-fit:cover;
      }
      .printPhoto img.portrait{
        transform: rotate(90deg);
      }
      .printCaption{
        font-size:12px;
        color:#334155;
        margin-top:6px;
        line-height:1.35;
      }

      .printTitlePage{
        display:flex;
        flex-direction:column;
        justify-content:flex-start;
        min-height: auto;
        gap:12px;
        padding:28px 24px;
        border:1px solid rgba(226,232,240,0.9);
        border-radius:16px;
        background:#fff;
      }
      .printTitleHero{
        font-size:24px;
        font-weight:1300;
        color: var(--navy);
      }
      .printMetaGrid{
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap:12px;
        margin-top:6px;
      }
      .printMetaCard{
        border:1px solid rgba(226,232,240,0.95);
        border-radius:12px;
        padding:12px;
        background:#fff;
      }
      .printIndexList{
        margin:0;
        padding-left:18px;
        display:grid;
        gap:4px;
        font-size:12px;
      }
      .printBlock{
        white-space:pre-wrap;
        font-size:12px;
        line-height:1.55;
        color:#1F2937;
      }
      .printKeyValue{
        display:grid;
        grid-template-columns: 170px 1fr;
        gap:6px 10px;
        font-size:12px;
      }
      .printDivider{
        height:1px;
        background: rgba(226,232,240,0.95);
        margin:10px 0;
      }

      .authOverlay{
        position: fixed;
        inset: 0;
        background: rgba(15,23,42,0.65);
        display:flex;
        align-items:center;
        justify-content:center;
        z-index: 300;
        backdrop-filter: blur(6px);
      }
      .authCard{
        width:min(420px, 92%);
        background:#fff;
        border-radius:16px;
        padding:20px;
        border:1px solid rgba(226,232,240,0.95);
        box-shadow: 0 24px 48px rgba(2,6,23,0.25);
      }
      .authTitle{
        font-size:18px;
        font-weight:1200;
        color: var(--navy);
        margin-bottom:6px;
      }
      .authHint{
        font-size:12px;
        color: var(--sub);
        margin-bottom:12px;
      }
      .authError{
        font-size:12px;
        color:#B91C1C;
        margin-top:8px;
      }

      @keyframes viewEnter{
        from{ opacity:0; transform: translateY(6px); }
        to{ opacity:1; transform: translateY(0); }
      }

      @media (prefers-reduced-motion: reduce){
        .app,
        .reportView{
          animation: none;
        }
      }

      @media print{
        body, html{ overflow:visible; }
        .app{ display:block; }
        .canvasZone, .panel, .reportView, .photosView, .authOverlay, .modeToggle, .sidebarToggle, .sidebarDock, .saveToast, .modalBackdrop, .topBar, .propertiesBar{ display:none !important; }
        .printSheet{
          display:block;
          padding:24px;
        }
        @page{
          size: portrait;
          margin: 12mm;
        }
        @page :first{
          size: landscape;
          margin: 12mm;
        }
      }

      /* ========= Heading edit UI ========= */
      .headingRow{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
      }
      .heading{
        font-size:18px;
        font-weight:1300;
        color:#0B1220;
        line-height:1.1;
        margin:0;
      }
      .editPill{
        width:40px;
        height:40px;
        border-radius:14px;
        border:1px solid rgba(11,167,165,0.45);
        background: rgba(11,167,165,0.22);
        color: var(--teal);
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        user-select:none;
        -webkit-user-select:none;
      }
      .editPill:hover{ background: rgba(11,167,165,0.18); }

      /* ========= Icons ========= */
      .ico{ width:18px; height:18px; color: currentColor; }

      /* ========= Mobile Menu ========= */
      .mobileMenuOverlay{
        position: fixed;
        inset: 0;
        background: rgba(15,23,42,0.35);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        z-index: 170;
      }
      .mobileMenuOverlay.show{
        opacity: 1;
        pointer-events: auto;
      }
      .mobileMenuSheet{
        position: fixed;
        left: 50%;
        bottom: 14px;
        transform: translateX(-50%) translateY(120%);
        width: min(520px, calc(100% - 24px));
        background: rgba(255,255,255,0.98);
        border-radius: 24px;
        box-shadow: 0 24px 46px rgba(2,6,23,0.28);
        border: 1px solid rgba(226,232,240,0.9);
        z-index: 180;
        transition: transform 0.25s ease;
        display: flex;
        flex-direction: column;
        max-height: calc(100dvh - 120px);
        overflow: hidden;
        backdrop-filter: blur(12px);
      }
      .mobileMenuSheet.open{
        transform: translateX(-50%) translateY(0);
      }
      .mobileMenuHeader{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        padding:14px 18px 10px;
        border-bottom:1px solid rgba(226,232,240,0.8);
      }
      .mobileMenuTitle{
        font-size:16px;
        font-weight:1200;
        color: var(--text);
      }
      .mobileMenuSubtitle{
        font-size:12px;
        color: var(--sub);
      }
      .mobileMenuContent{
        padding: 12px 18px 18px;
        overflow-y: auto;
      }
      .mobileMenuSection + .mobileMenuSection{
        margin-top: 16px;
      }
      .mobileMenuSectionTitle{
        font-size:12px;
        font-weight:1200;
        color: var(--sub);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 8px;
      }
      .mobileMenuGrid{
        display:grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }

      /* ========= Responsive ========= */
      @media (max-width: 1180px){
        .app{ grid-template-columns: 1fr minmax(280px, 360px); }
        .panelHeader{
          padding:8px 10px 4px;
        }
        .panelHeaderTitle{
          font-size:11px;
        }
        .pScroll{
          padding:8px;
        }
        .card{
          padding:10px;
        }
      }
      @media (max-width: 980px){
        .app{ grid-template-columns: 1fr minmax(300px, 360px); }
      }
      @media (max-width: 820px){
        :root{
          --propsbar-height: 124px;
          --mobile-font: calc(13px * var(--mobile-scale));
          --mobile-title: calc(18px * var(--mobile-scale));
          --mobile-control: calc(36px * var(--mobile-scale));
        }
        body{
          font-size: var(--mobile-font);
        }
        .topBar{
          font-size: calc(10px * var(--mobile-scale));
        }
        .propertiesBar{
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
          height: var(--propsbar-height);
          padding: 10px 14px 12px;
        }
        .propertiesBar.isMobile{
          background: linear-gradient(145deg, rgba(14,165,233,0.98), rgba(59,130,246,0.98));
        }
        .propertiesLeft{
          width: 100%;
          justify-content: space-between;
        }
        .propertiesInfo{
          max-width: 100%;
        }
        .propertiesTitle{
          font-size: var(--mobile-title);
        }
        .propertiesSub{
          font-size: calc(11px * var(--mobile-scale));
        }
        .propertiesPageLabel{
          font-size: calc(9px * var(--mobile-scale));
        }
        .propertiesPageInput{
          font-size: calc(10px * var(--mobile-scale));
        }
        .propertiesRight{
          width: 100%;
          justify-content: space-between;
          gap: 10px;
        }
        .propertiesActions{
          width: 100%;
          justify-content: flex-start;
        }
        .hdrBtn,
        .hdrPillBtn{
          font-size: calc(12px * var(--mobile-scale));
          min-height: var(--mobile-control);
        }
        .modeToggle{
          flex: 1;
          justify-content: space-between;
        }
        .modeToggle button{
          font-size: calc(12px * var(--mobile-scale));
          padding: 8px 12px;
        }
        .panelHeaderTitle{
          font-size: calc(11px * var(--mobile-scale));
        }
        .lbl{
          font-size: calc(10px * var(--mobile-scale));
        }
        .inp,
        select,
        textarea{
          font-size: calc(13px * var(--mobile-scale));
          padding: 12px 14px;
        }
        textarea{
          min-height: calc(84px * var(--mobile-scale));
        }
        .btn{
          font-size: calc(12px * var(--mobile-scale));
          min-height: var(--mobile-control);
        }
        .radio{
          font-size: calc(12px * var(--mobile-scale));
          min-height: var(--mobile-control);
        }
        .chip{
          font-size: calc(11px * var(--mobile-scale));
        }
        .mobileMenuSheet{
          width: min(560px, calc(100% - 20px));
        }
        .app{ grid-template-columns: 1fr; }
        .toolbar{
          max-width: calc(100% - 24px);
          left: 50% !important;
          top: calc(var(--topbar-height) + var(--propsbar-height) + 6px) !important;
          transform: translateX(-50%);
          padding: 6px 8px;
        }
        .toolbar.mobile{
          padding: 6px 8px;
        }
        .tbTools{
          max-width: 100%;
          overflow-x: auto;
          padding-bottom: 4px;
          scroll-snap-type: x mandatory;
        }
        .toolBtn{
          scroll-snap-align: center;
        }
        .panel{
          position: fixed;
          top: calc(var(--topbar-height) + var(--propsbar-height));
          right: 0;
          bottom: 0;
          height: calc(100vh - var(--topbar-height) - var(--propsbar-height));
          width: min(100%, 520px);
          border-radius: 18px 0 0 18px;
          transform: translateX(100%);
          transition: transform 0.2s ease;
          z-index: 90;
        }
        .panel.mobileOpen{
          transform: translateX(0);
        }
        .panelOverlay{
          position: fixed;
          top: calc(var(--topbar-height) + var(--propsbar-height));
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(15,23,42,0.35);
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.2s ease;
          z-index: 85;
        }
        .panelOverlay.show{
          opacity: 1;
          pointer-events: auto;
        }
        .modalCard{
          width: min(96vw, 720px);
          max-height: calc(100dvh - 24px);
          border-radius:16px;
        }
        .modalHeader,
        .modalActions{
          flex-wrap: wrap;
          gap:8px;
        }
        .pHeader{
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        .hdrActions{
          flex-wrap: wrap;
          justify-content: flex-start;
          width: 100%;
        }
        .hdrText{
          width: 100%;
        }
        .sidebarDock{
          left: 50%;
          right: auto;
          transform: translateX(-50%);
          align-items:center;
        }
        .dashTable{
          font-size:10px;
        }
        .dashTable th,
        .dashTable td{
          white-space: normal;
        }
        .mobileDock{
          position: fixed;
          left: 10px;
          right: 10px;
          bottom: calc(16px + env(safe-area-inset-bottom));
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          padding: 12px;
          border-radius: 20px;
          background: rgba(15,23,42,0.65);
          box-shadow: 0 16px 30px rgba(2,6,23,0.24);
          backdrop-filter: blur(12px);
          z-index: 80;
        }
        .mobileDock .btn{
          flex: 1 1 0;
          min-height: var(--mobile-control);
          font-size: calc(12px * var(--mobile-scale));
        }
        .authCard{
          width: min(420px, 94%);
          padding: 18px;
        }
        .authCard .inp{
          font-size: 16px;
        }
        .authCard .btn{
          width: 100%;
        }
        .dashDock{
          margin: 0 4px 12px;
          border-radius: 18px;
        }
      }
